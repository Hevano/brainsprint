<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Analytics - Brain Sprint</title>
  <link rel="stylesheet" href="../css/brain_style.css">
  <link rel="stylesheet" href="../css/analytics_style.css">
  <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
  <script type="text/javascript" src="../js/setup-firebase.js"></script>
  <script src="../js/jquery-3.3.1.js"></script>
</head>
<body>
<div class="pagewrap">

<!-- Top part of the page, navigation -->
    <div id="div_head">
      <div id="div_logo_bar">

        <div id="div_logo">
          <img src="../images/brain.png" alt="brain_logo" id="brain_logo">
          <h1 id="brain_name">BrainSprint</h1>
          <img src="../images/profile_icon.png" alt="profile_icon" id="profile_icon">
        </div>
      </div>

      <nav id="div_nav_bar">
        <a id="nav_dashboard" class="nav_options" href="dashboard.html">Dashboard</a>
        <a id="nav_logout" class="nav_options" href="homepage.html">Log Out</a>
        <a id="nav_help" class="nav_options"  href="help.html">Help </a>
      </nav>
    </div>
</div>
<div id="div_pagename">
  <h1 id="pagename">Analytics</h1>
</div>
<!-- Search bar for the page -->
<div id="div_search_input">
  <form>
    <input type="text" id="search_text" placeholder="Search any word here to produce results"></input>
    <div id="search_button_wrap">
      <img src="../images/search.png" alt="search button" id="search_button"/>
    </div>
  </form>
</div>
<!-- Middle portion of page-->
<div id="div_body">
<!-- Prompt selection to change what information displays-->
  <div id="div_prompt_box">
    <form id="form_select_prompt">
      <select size="1" id="select_prompt">
        <option value="all" selected="selected">All prompts</option>
      </select>
    </form>
  </div>
<!-- Analytics content -->
  <div class="div_analytics_box">
    <div class="div_analytics_content">
      <div class="div_insight_title">
        <h1>Most common words</h1>
      </div>
      <div class="div_insight_content">

      </div>
    </div>
  </div>
  <div class="div_analytics_box">
    <div class="div_analytics_content">
      <div class="div_insight_title">
        <h1>Most unique words</h1>
      </div>
      <div id="div_insight_common" class="div_insight_content">
      </div>
    </div>
  </div>
  <div class="div_analytics_box">
    <div class="div_analytics_content">
        <div class="div_insight_title">
          <h1>Responses</h1>
        </div>
        <div class="div_insight_content">
        </div>
      </div>
  </div>
</div>
<div class="bottom">
  <div class="bottom_bar">
  </div>
</div>

<script>
  $(document).ready(function() {
    var uid = sessionStorage.getItem('uid')

    var myStorage = window.localStorage;
    var roomCode = myStorage.getItem("roomCode")
    console.log(roomCode);
    /**Populates each individual participant's responses in the database**/
    var rootRef = database.ref().child('/roomList/' + roomCode + '/replies/');
    rootRef.once('value', snapshot => {
      var rootValue = snapshot.val();
      var prompts = Object.keys(rootValue);
      var users = [];
      for (let i = 0; i < prompts.length; i++) {
        users[i] = Object.keys(rootValue[prompts[i]]);
      }
      var replies = [];
      for (let i = 0; i < users.length; i++) {
        replies[i] = [];
        for (let j = 0; j < users[i].length; j++) {
          replies[i][j] = Object.keys(rootValue[prompts[i]][users[i][j]]);
        }
      }

      console.log(rootValue[prompts[0]][users[0][0]][replies[0][0][0]]['text']);
      var people = [];
      var participantNames = [];
      for (let i = 0; i < users[0].length; i++) {
        participantNames[i] = users[0][i];
      }
      console.log(participantNames);
        for (let i = 0; i < participantNames.length; i++) {
          people[participantNames[i]] = [];
        }

        for (let i = 0; i < users.length; i++) {
          for (let j = 0; j < participantNames.length; j++) {
            for (let k = 0; k < replies[i][j].length; k++) {
              people[participantNames[j]][prompts[i]] = "";
            }
          }
        }

        for (let i = 0; i < users.length; i++) {
          for (let j = 0; j < participantNames.length; j++) {
            for (let k = 0; k < replies[i][j].length; k++) {
            people[participantNames[j]][prompts[i]] += rootValue[prompts[i]][users[0][j]][replies[i][j][k]]['text'] + " ";
            }
          }
      }
      database.ref().child('roomList/' + roomCode + '/analytics/people/').set(people);

});

/**---------Updates the total textCollection in database to allow analytics to pull data easily.---------**/
    var personal = {};
    var personalPrompts = {};
    var firstRef = database.ref().child('/roomList/' + roomCode + '/replies/');
    firstRef.once('value', snapshot => {
      var totalText = "";
      snapshot.forEach(function(prompt) {
        var promptKey = prompt.key;
        var promptData = prompt.val();
        personalPrompts[promptKey] = "";
        var secondRef = firstRef.child(promptKey + '/');
        secondRef.once('value', promptShot => {
            /**Name Tree**/
            promptShot.forEach(function(name){
            var nameKey = name.key;
            var nameData = name.val();
//            console.log(nameData);
            var thirdRef = secondRef.child(nameKey + '/');
            thirdRef.once('value', nameShot => {
              /**Response tree **/
              nameShot.forEach(function(response) {
                var responseKey = response.key;
                var responseData = response.val();

                var fourthRef = thirdRef.child(responseKey + '/');
                fourthRef.once('value', textShot => {
                    totalText += textShot.child('text').val() + " ";

                    var textCollection = {
                      textCollection: totalText
                    };


                    /**Updates the total text collection.**/
                    database.ref().child('/roomList/' + roomCode + '/analytics/').update(textCollection);


                  });
              });
            });
          });
        });
      });
    });
   populate_prompts();
   countWords();
   });

  /**populates the drop-down menu for prompts**/
  function populate_prompts() {
    var myStorage = window.localStorage;
    var roomCode = myStorage.getItem('roomCode');
    var promptNames = [];
    var addPrompt;
    let i = 1;
    var firstRef = database.ref().child('/roomList/' + roomCode + '/prompts/');
    firstRef.once('value', numShot => {
      numShot.forEach(function(prompt) {
        var promptKey = prompt.key
        var secondRef = firstRef.child(promptKey + '/text/').once('value', promptShot => {
          addPrompt = $('<option>').attr('value', promptShot.val()).html(promptShot.val());
          $('#select_prompt').append(addPrompt);
        });
      });
    });
  }
  
  /**Separates the textCollection into an array and counts words.**/
  function countWords() {
    var myStorage = window.localStorage;
    var textArray;
    var roomCode = myStorage.getItem('roomCode');
    console.log(roomCode);
    database.ref().child('/roomList/' + roomCode + '/analytics/').once('value', snapshot => {
      var string = snapshot.val().textCollection;
      textArray = string.split(" ");
      console.log(textArray);
    });
  }

</script>
</body>
</html>
