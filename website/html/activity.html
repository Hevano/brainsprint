<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>[Activity Title here] - Brain Sprint</title>
  <link rel="stylesheet" href="../css/brain_style.css">
  <link rel="stylesheet" href="../css/activity_style.css">
  <link rel="icon" href="../images/brain.png">
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
  <script type="text/javascript" src="../js/setup-firebase.js"></script>
  <script src="../js/jquery-3.3.1.js"></script>
  <style type="text/css">
    @keyframes rotateAnim {
       from {
         transform: rotate(0deg);
       }
       to {
         transform: rotate(360deg);
       }
     }

     #div_time img {
       animation-name: rotateAnim;
       animation-duration: 2s;
       animation-timing-function: linear;
       animation-iteration-count: infinite;
       animation-fill-mode: forwards;
     }
  </style>
</head>

<body>
  <div class="pagewrap">
    <div id="div_head">
      <div id="div_logo_bar">

        <div id="div_logo">
          <a href="dashboard.html"><img src="../images/brain.png" alt="brain_logo" id="brain_logo"></a>
          <h1 id="brain_name">BrainSprint</h1>
          <img src="../images/profile_icon.png" alt="profile_icon" id="profile_icon">
        </div>
      </div>

      <nav id="div_nav_bar">
        <a id="nav_dashboard" class="nav_options" href="dashboard.html">Dashboard</a>
        <a id="nav_logout" class="nav_options" href="homepage.html">Log Out</a>
        <a id="nav_help" class="nav_options"  href="help.html">Help </a>
      </nav>
    </div>

    <div id="div_pagename">
      <h1 id="pagename">[Current Theme]</h1>
    </div>

    <div id="div_content">
      <div id="div_time">
        <img src="../images/timer.png">
        <h2 id="timer"></h2>
      </div>

      <div id="div_submit_display">
        <!--Submission paragraph elements will appear here-->
      </div>

    </div>

    <div id="div_input">
      <form>
        <textarea id="submit_text">Text goes here</textarea>
        <input type="button" name="submit" value="ENTER" id="enter_button" class="button_style">
      </form>
    </div>

    <!-- Wait Popup -->
    <div class="wait_popup">
      <!-- Wait Popup Content -->
      <div class="wait_popup_content">
        <form class="form_wait" action="dashboard.html" method="post">
          <h2 id="wait_title">Room Name</h2>
          <p id="wait_code" class="wait_important"></p>
          <p id="wait_name" class="wait_important"></p>
          <p id="wait_msg">Please wait for the activity to start!</p>
          <p id="wait_home">Home</p>

        </form>
      </div>
    </div>

    <!-- New Prompt Popup -->
    <div class="new_popup">
      <!-- New Prompt Popup Content -->
      <div class="new_popup_content">
        <form class="form_wait" action="dashboard.html" method="post">
          <h2 id="new_prompt_title">Next Prompt Coming!</h2>
          <h2 id="new_prompt_text"></h2>
          <h2 id="new_prompt_timer"></h2>

        </form>
      </div>
    </div>

    <div class="bottom">
      <div class="bottom_bar">

      </div>
    </div>
  </div>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script>

      var duration;

      // Closes Join Room Popup
      function func_close_wait_pop() {
        $("div.wait_popup").css("display", "none");
      }

      // Brings up Join Room Popup
      function func_wait_pop() {
        $("div.wait_popup").css("display", "block");
      }

      function finish_pop() {
        // let participantName;
        // if (sessionStorage.getItem("name") != null) {
        //   participantName = sessionStorage.getItem("name")
        // } else {
        //   participantName = window.localStorage.getItem("name");
        // }
        $("div.wait_popup").css("display", "block");
        $("#wait_home").css("display", "block");
        $("div.wait_popup_content").css("height", "18em");
        $("#wait_name").html("Goodbye, " + userName);
        $("#wait_msg").html("The activity has now finished. Thanks for brainstorming with BrainSprint!");

        $("#wait_home").click(function(event) {
          console.log("we outta here");
          window.location.href = "homepage.html";
        });
      }

      function new_prompt_pop(durationCurrent, durationTotal) {
        let duration = Math.abs(durationCurrent - durationTotal);
        $("div.new_popup").css("display", "block");
        $("#new_prompt_timer").html("Starting in: " + duration + "...");
      }


        $(document).ready(function() {
          if (sessionStorage.getItem("name") != null) {
            var userName = sessionStorage.getItem("name")
          } else {
          var userName = window.localStorage.getItem("name");
          }
          $("#wait_name").html("Welcome, " + userName);
          var roomCode = window.localStorage.getItem("roomCode"); //What room are we in?
          $("#wait_code").html("#" + roomCode);

          var room = database.ref("roomList/" + roomCode);

          room.child("roomName").once('value', snapshot => {
                  $("title").html(snapshot.val() + " - BrainSprint Activity");
                  $("#wait_title").html(snapshot.val());
                });
          

          
          func_wait_pop();
          room.child("start").on('value', snapshot => {
            console.log("Change is registered");
            if(snapshot.val()) {
              console.log("change is acted on");
              populate_prompts(room);
            }
          });
          
           

          var responseNum = 0;
          $("#enter_button").click(function(event){
            var submission = $("#submit_text").val()
            if(!submission == "" || !("#submit_text").val() == "Text goes here") {
              var newItem = $("<p>" + $("#submit_text").val() + "</p>").addClass("reply");
              $("#div_submit_display").prepend(newItem).focus();
              $("#submit_text").val("Text goes here");
              //Send
              var reply = {};
              reply[responseNum] = {
                text: submission,
                votes: 0
              };
                
              console.log(reply);
                
                database.ref().child('roomList/' + roomCode + '/replies/' + $('#pagename').html() + '/' + userName).update(reply);                
                console.log(reply);
                responseNum++;
                console.log(responseNum);
              }
            else {
              console.log("nope");
            }
          });

          $("#submit_text").click(function(event){
            $("#submit_text").val("");
          });

        });

        //Returns an object that contains all prompts, with text and duration
        function populate_prompts (roomParam) {
          func_close_wait_pop();
          roomParam.child("prompts").once('value', snapshot => {
              var promptsList = snapshot.val();
              var index = 0;
              var duration = promptsList[index]["duration"] + 5;
              var grace = false;

              $("#timer").html(duration);
              $("#pagename").html(promptsList[index]["text"]);
              $("#new_prompt_text").html('"' + promptsList[index]["text"] + '"');

              var time = setInterval(function() {
                if(duration <= 0 && index < promptsList.length) { //If a prompt has finished
                  index++;
                  if (index == promptsList.length){ //If there are now more prompts
                    $("#timer").html(0);
                    finish_pop();
                    $("#div_input").css("display", "none");

                  } else { //else start the next prompt
                    $("#pagename").html(promptsList[index]["text"]);
                    $("#new_prompt_text").html('"' + promptsList[index]["text"] + '"');
                    duration = promptsList[index]["duration"] + 5; //give a 5 second grace period
                    $("#timer").html(0)
                    $(".reply").toggle();
                  }
                } else if (index == promptsList.length) {
                  console.log("It's over");
                    //alert("time's up!")
                } else {
                  if(duration > promptsList[index]["duration"]) { //checks if we are in grace period
                    console.log("Dont lie to me!", index);
                    new_prompt_pop(duration, promptsList[index]["duration"]);
                  } else {
                    $("#timer").html(duration);
                    $("div.new_popup").css("display", "none");
                  }
                  
                  duration--;
                }
              }, 1000);

            });
        }
    </script>


</body>

</html>
