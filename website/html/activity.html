<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>[Activity Title here] - Brain Sprint</title>
  <link rel="stylesheet" href="../css/brain_style.css">
  <link rel="stylesheet" href="../css/activity_style.css">
  <link rel="icon" href="../images/brain.png">
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
  <script type="text/javascript" src="../js/setup-firebase.js"></script>
  <script src="../js/jquery-3.3.1.js"></script>
  <style type="text/css">
    @keyframes rotateAnim {
       from {
         transform: rotate(0deg);
       }
       to {
         transform: rotate(360deg);
       }
     }

     #div_time img {
       animation-name: rotateAnim;
       animation-duration: 2s;
       animation-timing-function: linear;
       animation-iteration-count: infinite;
       animation-fill-mode: forwards;
     }
  </style>
</head>

<body>
  <div class="pagewrap">
    <div id="div_head">
      <div id="div_logo_bar">

        <div id="div_logo">
          <a href="dashboard.html"><img src="../images/brain.png" alt="brain_logo" id="brain_logo"></a>
          <h1 id="brain_name">BrainSprint</h1>
          <img src="../images/profile_icon.png" alt="profile_icon" id="profile_icon">
        </div>
      </div>

      <nav id="div_nav_bar">
        <a id="nav_dashboard" class="nav_options" href="dashboard.html">Dashboard</a>
        <a id="nav_logout" class="nav_options" href="homepage.html">Log Out</a>
        <a id="nav_help" class="nav_options"  href="help.html">Help </a>
      </nav>
    </div>

    <div id="div_pagename">
      <h1 id="pagename">[Current Theme]</h1>
    </div>

    <div id="div_content">
      <div id="div_time">
        <img src="../images/timer.png">
        <h2 id="timer"></h2>
      </div>

      <div id="div_submit_display">
        <!--Submission paragraph elements will appear here-->
      </div>

    </div>

    <div id="div_input">
      <form>
        <textarea id="submit_text">Text goes here</textarea>
        <input type="button" name="submit" value="ENTER" id="enter_button" class="button_style">
      </form>
    </div>

    <div class="bottom">
      <div class="bottom_bar">

      </div>
    </div>
  </div>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script>

      var duration;


        $(document).ready(function() {
          var userName = window.localStorage.getItem("name");
          console.log(userName);
          var roomCode = window.localStorage.getItem("roomCode"); //What room are we in?

          var room = database.ref("roomList/" + roomCode);

          room.child("roomName").once('value', snapshot => {
                  $("title").html(snapshot.val() + " - BrainSprint Activity"); //potential security flaw here, if the user creates a room name that contains shady code it will be inserted into the title
                });

          populate_prompts(room); 

          var responseNum = 0;
          $("#enter_button").click(function(event){
            var submission = $("#submit_text").val()
            if(!submission == "" || !("#submit_text").val() == "Text goes here") {
              var newItem = $("<p>" + $("#submit_text").val() + "</p>")
              $("#div_submit_display").prepend(newItem).focus();
              $("#submit_text").val("Text goes here");
              //Send
              var postData = {
                name: userName,
                prompt: $("#pagename").html(),
                text: submission,
                votes: 0,

              };

              
              database.ref().child('roomList/' + roomCode + '/replies/' + userName + '/' + responseNum).set(postData);
              console.log(postData);
              responseNum++;
              console.log(responseNum);
            }
            else {
              console.log("nope");
            }
          });

          $("#submit_text").click(function(event){
            $("#submit_text").val("");
          });

        });

        //Returns an object that contains all prompts, with text and duration
        function populate_prompts (roomParam) {
          roomParam.child("prompts").once('value', snapshot => {
              var promptsList = snapshot.val();
              var index = 0;
              var duration = promptsList[index]["duration"];

              $("#timer").html(duration);
              $("#pagename").html(promptsList[index]["text"]);
              var time = setInterval(function() {
                if(duration <= 0 && index < promptsList.length) {
                  index++;
                  if (index == promptsList.length){
                    console.log("It's over");
                    //alert("time's up!")
                  } else {
                    $("#pagename").html(promptsList[index]["text"]);
                    duration = promptsList[index]["duration"];
                    $("#timer").html(duration);
                  }
                } else if (index == promptsList.length) {
                  console.log("It's over");
                    //alert("time's up!")
                } else {
                  $("#timer").html(duration);
                  duration--;
                }
              }, 1000);

            });
        }
    </script>


</body>

</html>
