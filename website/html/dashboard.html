<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>BrainSprint</title>
  <link rel="stylesheet" href="../css/brain_style.css">
  <link rel="stylesheet" href="../css/dashboard_style.css">
  <link rel="icon" href="../images/brain.png">
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
</head>

<body>
  <div class="pagewrap">
    <div id="div_head">
      <div id="div_logo_bar">

        <div id="div_logo">
          <a href="dashboard.html"><img src="../images/brain.png" alt="brain_logo" id="brain_logo"></a>
          <h1 id="brain_name">BrainSprint</h1>
          <img src="../images/profile_icon.png" alt="profile_icon" id="profile_icon">
        </div>
      </div>

      <nav id="div_nav_bar">
        <a id="nav_dashboard" class="nav_options" href="dashboard.html">Dashboard</a>
        <a id="nav_logout" class="nav_options" href="homepage.html">Log Out</a>
        <a id="nav_help" class="nav_options" href="help.html">Help </a>
      </nav>
    </div>

    <div id="div_pagename">
      <h1 id="pagename">BrainLaps</h1>
    </div>

    <div class="div_body_base">
      <!-- Navigation Bar -->
      <div id="body_options_bar">
        <ul id="body_options_nav">
          <li id="option_your_room" class="body_options" onclick="yourRoom_up()">Your Room</li>
          <li id="option_analytics" class="body_options" onclick="analytics_up()">Analytics</li>
          <li id="option_joined_room" class="body_options" onclick="joinedRoom_up()">Joined Room</li>
        </ul>
      </div>

      <!-- Dashboard Body -->
      <div id="div_body_yourRoom" class="div_body">
        <a href="create.html"><img src="../images/add.png" alt="add_button" id="add_button"></a>
      </div>

      <!-- Analytics Page -->
      <div id="div_body_analytics" class="div_body">

      </div>

      <!-- Joined Rooms Page-->
      <div id="div_body_joinedRoom" class="div_body">
        <!-- Join Room Button -->
        <a onclick="func_join_room_pop()"><img src="../images/add.png" alt="add_button" id="join_button"></a>

        <!-- Join Room Popup -->
        <div class="join_room_popup">
          <!-- Join Room Popup Content -->
          <div class="join_room_popup_content">
            <span class="close" onclick="func_close_join_room_pop()">&times;</span>
            <form class="form_join_room" action="dashboard.html" method="post">
              <!-- <legend>Enter Room Number</legend> -->
              <p id="pop_name">Enter Room Code: </p>
              <input id="input_text" name="room_number" type="text" placeholder="Enter Here">
              <input id="input_button" type="button" name="Enter" value="submit" onclick="room_validate()">
              <p id="pop_message">&nbsp;</p>

            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom">
      <div class="bottom_bar">
      </div>
    </div>

  </div>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.6/firebase.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      console.log("Page loaded with user: " + sessionStorage.getItem("uid"));
      console.log("Name: " + sessionStorage.getItem("name"));
    })

    var user = sessionStorage.getItem("uid");

    // Create Room Page Display
    function yourRoom_up() {
      document.getElementById("div_body_yourRoom").style.display = "block";
      document.getElementById("div_body_analytics").style.display = "none";
      document.getElementById("div_body_joinedRoom").style.display = "none";

      document.getElementById("option_your_room").style.backgroundColor = "rgb(134, 190, 131)";
      document.getElementById("option_analytics").style.backgroundColor = "rgb(226, 226, 226)";
      document.getElementById("option_joined_room").style.backgroundColor = "rgb(226, 226, 226)";
    }

    // Analytics Room Page Display
    function analytics_up() {
      document.getElementById("div_body_yourRoom").style.display = "none";
      document.getElementById("div_body_analytics").style.display = "block";
      document.getElementById("div_body_joinedRoom").style.display = "none";

      document.getElementById("option_your_room").style.backgroundColor = "rgb(226, 226, 226)";
      document.getElementById("option_analytics").style.backgroundColor = "rgb(134, 190, 131)";
      document.getElementById("option_joined_room").style.backgroundColor = "rgb(226, 226, 226)";
    }

    // Join Room Page Display
    function joinedRoom_up() {
      document.getElementById("div_body_yourRoom").style.display = "none";
      document.getElementById("div_body_analytics").style.display = "none";
      document.getElementById("div_body_joinedRoom").style.display = "block";

      document.getElementById("option_your_room").style.backgroundColor = "rgb(226, 226, 226)";
      document.getElementById("option_analytics").style.backgroundColor = "rgb(226, 226, 226)";
      document.getElementById("option_joined_room").style.backgroundColor = "rgb(134, 190, 131)";
    }

    // Join Room Pop Up Functions
    var join_room = $(".join_room_popup");
    var span = document.getElementsByClassName("close")[0];

    // Closes Join Room Popup
    function func_close_join_room_pop() {
      join_room.css("display", "none");
    }

    // Brings up Join Room Popup
    function func_join_room_pop() {
      join_room.css("display", "block");
    }

    // Populates the Create Page -------------------------------------------------------------------------------------------------------------

    var config = {
      apiKey: "AIzaSyAZwdjR0wpNxj0yG0YLN1ueuMa6L-NLd2A",
      authDomain: "brainsprint-92cf3.firebaseapp.com",
      databaseURL: "https://brainsprint-92cf3.firebaseio.com",
      projectId: "brainsprint-92cf3",
      storageBucket: "brainsprint-92cf3.appspot.com",
      messagingSenderId: "117462095616"
    };

    firebase.initializeApp(config);
    var db = firebase.database();

    //----------------------------------------------------------------------------------------------------------------------------------------
    var list_of_rooms = [];

    // loads the rooms and the data
    $(document).ready(function() {
      var rooms_saved = db.ref("userList/" + user + "/rooms");
      rooms_saved.once("value").then(function(s) {
        var room_array = s.val();
        var room_length = Object.keys(room_array).length;

        for (i = 0; i < room_length; i++) {
          var room_number = Object.keys(room_array)[i];
          list_of_rooms[i] = room_number;
          func_has_started(rooms_saved, room_number);
        };

      });
    });

    // Checks if the room status and calls the function to create and populate the rooms---------------------------------------------------------
    function func_has_started(rooms_saved, room_number) {
      var has_started = rooms_saved.child(room_number).child("start");
      has_started.once("value").then(function(r) {
        var started = r.val();
        // console.log("In Room #" + room_number + "\n" + "Status: " + started);

        if (started) {
          $("#div_body_analytics").append(create_room(room_number, started));
          func_populate(room_number);
        } else {
          $("#div_body_yourRoom").append(create_room(room_number, started));
          func_populate(room_number);
        }
      });
    }

    // Checks if roomCode exist and creates the elements-------------------------------------------------------------------------------------------
    function room_validate() {
      var room_number = document.getElementById('input_text').value;
      const room = db.ref().child("roomList/" + room_number);

      event.preventDefault();

      //checks if room exists
      if (room_number.length == 0) {
        $("#pop_message").html("Please Enter a Room Number");
      } else {
        room.once('value', snapshot => {
          if (snapshot.exists()) {
            room.child("start").once("value").then(function(s) {
              var started = s.val();

              //for each loop for list_of_rooms look throught if the room number entered is one of the users rooms
              var users_room = func_is_users_room(room_number);
              if (users_room){
                $("#pop_message").html("Code #" + room_number + " is your room");
              }
              else {
                if (started) {
                  $("#pop_message").html("Code #" + room_number + " Already started");
                } else {
                  func_join_room();
                }
              }
            });
          } else {
            $("#pop_message").html("Code #" + room_number + " does not exist");
          }
        });
      }
    }

    function func_is_users_room(room_number) {
      for (i = 0 ; i < list_of_rooms.length ; i++){
        if (room_number == list_of_rooms[i]){
          console.log("Your room");
          return true;
        }
      }
      console.log("not your room");
      return false;
    }

    // function that creates the divs for joined room------------------------------------------------------------------------------------------------
    function func_join_room() {
      var room_number = document.getElementById('input_text').value;

      $("#div_body_joinedRoom").append(create_room(room_number, false));
      func_populate(room_number);
      func_close_join_room_pop();
    }


    // Function that createds the div elements---------------------------------------------------------------------------------------------------------
    function create_room(room_number, status) {
      var div_room_joined = $("<div>").attr("id", "room_joined_" + room_number).addClass("room_joined");

      var div_detail = $("<div>").attr("id", "room_details_" + room_number).addClass("room_details");

      var h3_name = $("<h3>").html("Room Name").attr("id", "room_name_" + room_number).addClass("room_name");

      var p_topic = $("<p>").html("Topic: ").addClass("room_topic");
      var span_topic = $("<span>").attr("id", "room_topic_" + room_number).addClass("room_topic");

      var p_number = $("<p>").html("Room Number: ").addClass("room_number");
      var span_number = $("<span>").html(room_number).attr("id", "room_number_" + room_number).addClass("room_number");

      var div_options = $("<div>").attr("id", "room_options_" + room_number).addClass("action_options");
      var img_options = $("<img>").attr("src", "../images/options_icon.png").attr("id", "options_icon_" + room_number).addClass("icon_button");

      if (status) {
        var button_options = $("<button>").html("Analytics").attr("id", "button_start_" + room_number).addClass("button_analytics").attr('value', room_number).attr("onclick", "set_storage(this)").attr("onclick",
          "location.href='analytics.html'"); //change class name to something else
      } else {
        var button_options = $("<button>").html("Start").attr("id", "button_start_" + room_number).addClass("button_create_room_start").attr('value', room_number).attr("onclick", "set_storage(this)").attr("onclick",
          "location.href='activity.html'"); //change class name to something else
      }

      $(p_topic).append(span_topic);
      $(p_number).append(span_number);

      var append_options = $(div_options).append(img_options, button_options);
      var append_details = $(div_detail).append(h3_name, p_topic, p_number);

      return $(div_room_joined).append(append_details, append_options);
    }


    // Populates the created room with the datbase data--------------------------------------------------------------------------------------------------
    function func_populate(room_number) {
      var room = db.ref().child("roomList").child(room_number);

      var room_name = document.getElementById('room_name_' + room_number);
      var room_topic = document.getElementById('room_topic_' + room_number);
      var room_num = document.getElementById('room_number_' + room_number);

      var db_room_name = room.child("roomName");
      var db_room_topic = room.child("prompts");

      db_room_topic.once("value")
        .then(function(s) {
          var num = s.val();

          for (i = 0; i < Object.keys(num).length; i++) {
            var topic = db_room_topic.child(i + "/text");
            topic.once("value")
              .then(function(s) {
                var topics = s.val() + '\xa0';
                db_room_topic.on('value', snap => room_topic.innerText += topics);
              });
          }
        });

      db_room_name.on('value', snap => room_name.innerText = snap.val());
      room.on('value', snap => room_num.innerText = room_number);
    }


    // Get the value of the owner--------------------------------------------------------------------------------------------------------------------------------
    function set_storage(e) {
      var myStorage = window.localStorage;

      var ref = db.ref("userList/" + user + "/name");
      ref.once("value")
        .then(function(s) {
          var name_thing = s.val();
          myStorage.setItem("name", name_thing);
        })
      var code_value = document.getElementById(e.id).value + "";
      myStorage.setItem("roomCode", code_value);
    }

    // Adds the Joined room to the database
  </script>

</body>

</html>
