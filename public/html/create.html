<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Create - Brainsprint</title>
        <meta charset="utf-8"/>
        <link rel="stylesheet" href="../css/brain_style.css">
        <link rel="stylesheet" href="../css/create_style.css">
        <link rel="icon" href="../images/brain.png">
        <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
        <script type="text/javascript" src="../js/setup-firebase.js"></script>
        <script src="../js/jquery-3.3.1.js"></script>
    </head>
    <body>
      <div class="pagewrap">
        <div id="div_head">

          <div id="div_logo_bar">

            <div id="div_logo">
              <a href="dashboard.html"><img src="../images/brain.png" alt="brain_logo" id="brain_logo"></a>
              <h1 id="brain_name">BrainSprint</h1>
              <img src="../images/profile_icon.png" alt="profile_icon" id="profile_icon">
            </div>

            <div class="div_profile">

            </div>

          </div>

          <div id="div_nav_bar">
            <a id="nav_dashboard" class="nav_options" href="dashboard.html">Dashboard</a>
            <a id="nav_logout" class="nav_options"  href="homepage.html">Log Out</a>
          </div>
        </div>

        <div id='div_create'>
          <div id="div_pagename">
            <h1 id="pagename">Create a Room</h1>
          </div>
          <div id='div_form'>
            <form class="create_form" id="create_room_form">
              <fieldset class="title_form">
                <input type="text" id="room_name" name="name" placeholder="Room Name" required="required" pattern="[A-Za-z]">
                <!-- <span class="tooltip"><abbr title="The name of the room that you will create">?</abbr></span> -->
                <div class="tooltip">?
                  <span class="tooltiptext">The name of the room that you will create</span>
                </div>
              </fieldset>

              <br>

              <fieldset class="topic" id="topic_fieldset">
                <input type="text" name="topic1" placeholder="Topic Title" required="required" class="topic_name">
                <!-- <span class="tooltip"><abbr title="A topic that you will be brainstorming on">?</abbr></span> -->
                <div class="tooltip">?
                  <span class="tooltiptext">A topic that you will be brainstorming on</span>
                </div>

                <br>
                <label id="time_select_label">Topic Duration:</label>
                <select size="1" name="time" id="time" class="time_select">
                  <option value="30" selected="selected">30 seconds</option>
                  <option value="60">1 minute</option>
                  <option value="120">2 minutes</option>
                  <option value="180">3 minutes</option>
                  <option value="240">4 minutes</option>
                  <option value="320">5 minutes</option>
                </select>
                <!-- <span class="tooltip"><abbr title="The amount of time that brain sprinters can reply to a topic">?</abbr></span> -->
                <div class="tooltip">?
                  <span class="tooltiptext">The amount of time that brain sprinters can reply to a topic</span>
                </div>

                <!-- <span class="tooltip" id="trash_tool"><abbr title="This button deletes this topic">?</abbr></span> -->
                <div class="tooltip" id="trash_tool">?
                  <span class="tooltiptext">This button deletes this topic</span>
                </div>
                <input type="button" id="delete1" onclick="deletePrompt(event)" name="delete1" value="Trash" class="trash_button"/>

              </fieldset>
              <br>
              <input type="button" id="create_prompt_button" onclick="createPrompt()" name="new" value="Add more topics" class="create_input">
              <!-- <span class="tooltip"><abbr title="The amount of time that brain sprinters can reply to a topic">?</abbr></span> -->
              <div class="tooltip">?
                <span class="tooltiptext">The amount of time that brain sprinters can reply to a topic</span>
              </div>

              <input type="button" onclick="resetFields()" id="reset_button" name="reset_button" value="Reset" class="button_final"/>
              <!-- <span class="tooltip"><abbr title="This button clears all of the information you have added in the area above">?</abbr></span> -->
              <div class="tooltip">?
                <span class="tooltiptext">This button clears all of the information you have added in the area above</span>
              </div>

              <input type="button" id="create_button" name="create" value="Create" class="button_final"/>
              <!-- <span class="tooltip"><abbr title="This button saves the information you have put in and creates your room">?</abbr></span> -->
              <div class="tooltip">?
                <span class="tooltiptext">This button saves the information you have put in and creates your room</span>
              </div>

            </form>
          </div>
        </div>
        <div class="bottom">
          <div class="bottom_bar">

          </div>
        </div>
      </div>

      <script>
          /*<![CDATA[*/

          /**Prints the current user's id and name to console.**/
          $(document).ready(function(){
            console.log("Page loaded with user: " + sessionStorage.getItem("uid"));
            console.log("Name: " + sessionStorage.getItem("name"));
          })

          /**Resets the form.**/
          function resetFields() {
            var form = document.getElementById("create_room_form").reset();
          }

          /**Adds a new input area for adding a new prompt.**/
          function createPrompt() {
            var newTopic = document.getElementById("topic_fieldset");
            var clone = newTopic.cloneNode(true);
            $(clone).css("margin-bottom", "2em");
            var cloneC = clone.children;
            cloneC[0].value = "";
            cloneC[3].value = 30;
            $(cloneC[6]).css("visibility", "visible");
            $(cloneC[7]).css("visibility", "visible");
            document.getElementById("create_prompt_button").before(clone);

          }

          /**Deletes the topic which this button was clicked from. **/
          function deletePrompt(event) {
            var trigger = event.target;
            console.log(trigger.parentNode);
            trigger.parentNode.remove();
          }

          /**Prevents the user from using any odd characters in the title of the room**/
          $('#room_name').on('change keyup keydown',function(){
                  var txt = $(this).val();
                  $(this).val(/[A-Za-z]/.test(txt) ? txt : txt.substring(0,txt.length-1) );
              });


          /**Processes the information in the form and saves it in database.**/

          $('#create_button').click(function(event) {
            event.preventDefault();
            var roomName = document.getElementById("room_name");
            var topicNames = document.getElementsByClassName("topic_name");
            var topicTimes = document.getElementsByClassName("time_select");
            var prompts = {};
            for (let i = 0; i < topicNames.length; i++) {
              prompts[i] = {
                text: topicNames[i].value,
                duration: parseInt(topicTimes[i].value, 10)
              };
            }

            console.log(topicNames);
            console.log(topicTimes);
            console.log(prompts);

            /** Grabs the user id and room information and assigns the information
            *   to the correct user id.
            **/

            var uid = sessionStorage.getItem("uid");
            var postData = {
              roomName: roomName.value,
              prompts: prompts,
              owner: uid,
              start: false
            };

            /**Updates room to roomList and also populates the room under userID.**/
            var roomCode;
            var numUpdate;
            database.ref().child('numRooms').once('value', snapshot => {
              roomCode = snapshot.val() + 1;
              console.log(snapshot.val());
              console.log(roomCode);
              numUpdate = {
                numRooms: roomCode
              }

              console.log(numUpdate);
              database.ref().update(numUpdate);

              var roomInfo = {};
              roomInfo[roomCode] = postData;


              var dbUpdate = database.ref().child('roomList').update(roomInfo);

              var updates = {};
              updates['/userList/' + uid + '/rooms/' + roomCode] = postData;
              database.ref().update(updates);


              console.log("updated database!");
              window.location = 'dashboard.html'

            });
          });

        /*]]>*/
      </script>
    </body>
</html>
